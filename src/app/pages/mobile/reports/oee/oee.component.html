<div *ngIf="factoryData" class="row">
  <div class="col-12">
    <app-tv-header title="Reporte OEE" backButton="/"></app-tv-header>
  </div>
  <div class="col-12 mt-2">
    <mat-accordion>
      <mat-expansion-panel
        class="expansion-panel"
        [expanded]="filterOpen"
        (opened)="filterOpen = true"
        (closed)="filterOpen = false"
      >
        <mat-expansion-panel-header class="expansion-header"
          >Filtros
        </mat-expansion-panel-header>
        <form [formGroup]="form" (ngSubmit)="onSubmit()">
          <div class="row" *ngIf="rolePermissionsData">
            <div class="col-12">
              <mat-form-field class="w-100" appearance="standard">
                <mat-label>Planta</mat-label>
                <mat-select
                  formControlName="factoryId"
                  (selectionChange)="onFactoryChange($event)"
                  required
                >
                  <mat-option
                    *ngFor="let item of rolePermissionsData.factories"
                    [value]="item"
                  >
                    {{ item?.factoryName }}
                  </mat-option>
                </mat-select>
                <mat-error> {{ appMessage.FIELD_REQUIRED }} </mat-error>
              </mat-form-field>
            </div>
            <div class="col-12" *ngIf="factorySelected">
              <mat-form-field class="w-100" appearance="standard">
                <mat-label>Nave</mat-label>
                <mat-select formControlName="warehouseId" required>
                  <mat-option
                    *ngFor="let item of factorySelected.warehouses"
                    [value]="item.warehouseId"
                  >
                    {{ item?.warehouseName }}
                  </mat-option>
                </mat-select>
                <mat-error> {{ appMessage.FIELD_REQUIRED }} </mat-error>
              </mat-form-field>
            </div>
            <mat-divider class="mb-3"></mat-divider>
            <div class="col-6">
              <mat-form-field appearance="fill" class="oee-field">
                <mat-label>Fecha Inicio:</mat-label>
                <input
                  formControlName="startDate"
                  matInput
                  [matDatepicker]="startDate"
                />
                <mat-error> {{ appMessage.FIELD_REQUIRED }} </mat-error>
                <mat-datepicker-toggle
                  matSuffix
                  [for]="startDate"
                ></mat-datepicker-toggle>
                <mat-datepicker #startDate></mat-datepicker>
              </mat-form-field>
            </div>
            <div class="col-6">
              <mat-form-field appearance="fill" class="oee-field">
                <mat-label>Fecha Fin:</mat-label>
                <input
                  formControlName="endDate"
                  matInput
                  [matDatepicker]="endDate"
                />
                <mat-error> {{ appMessage.FIELD_REQUIRED }} </mat-error>
                <mat-datepicker-toggle
                  matSuffix
                  [for]="endDate"
                ></mat-datepicker-toggle>
                <mat-datepicker #endDate></mat-datepicker>
              </mat-form-field>
            </div>
            <div class="col-6">
              <div class="my-3 text-center">
                <button
                  (click)="cleanValues($event)"
                  color="secondary"
                  mat-raised-button
                >
                  <mat-icon>clear</mat-icon>
                  <span> Limpiar</span>
                </button>
              </div>
            </div>
            <div class="col-6">
              <div class="my-3 text-center">
                <button type="submit" color="primary" mat-raised-button>
                  <mat-icon>search</mat-icon>
                  <span> Buscar</span>
                </button>
              </div>
            </div>
          </div>
        </form>
      </mat-expansion-panel>
    </mat-accordion>
  </div>
  <div class="col-12" *ngIf="factoryData.warehouse">
    <div class="title-content text-center">
      <span class="title">{{ factoryData.warehouse.warehouse }}</span>
    </div>
  </div>
  <div class="col-12" *ngIf="!factoryData.warehouse">
    <div class="title-content text-center">
      <span class="title">Nave</span>
    </div>
  </div>
  <div class="row" *ngIf="!factoryData.warehouse">
    <div class="col-12 text-center">No se encontraron registros</div>
  </div>
  <div class="col-12" *ngIf="factoryData.warehouse">
    <span class="title-oee">Porcentaje</span>
    <highcharts-chart
      [Highcharts]="Highcharts"
      [options]="chartOptionsWarehouseIndicators"
      style="width: 100%; height: 436px; display: block"
    ></highcharts-chart>
    <mat-divider></mat-divider>
  </div>
  <div class="col-12" *ngIf="factoryData.warehouse">
    <highcharts-chart
      [Highcharts]="Highcharts"
      [options]="chartOptionsGauge"
      style="width: 100%; height: 245px; display: block"
    ></highcharts-chart>
    <mat-divider></mat-divider>
  </div>
  <div class="col-12">
    <div class="title-content text-center">
      <span class="title">Total Planta {{ factoryData.factory }}</span>
    </div>
  </div>  
  <div class="col-12 chart-overflow-x" *ngIf="factoryData.general.warehouses.length > 0">
    <highcharts-chart
      [Highcharts]="Highcharts"
      [options]="chartOptionsGnlIndicators"
      style="width: 100%; height: 446px; display: block"
    ></highcharts-chart>
    <mat-divider></mat-divider>
  </div>
  <div class="col-12" *ngIf="factoryData.general.warehouses.length > 0">
    <highcharts-chart
      [Highcharts]="Highcharts"
      [options]="chartOptionsGnlGauge"
      style="width: 100%; height: 30vh; display: block"
    ></highcharts-chart>
    <mat-divider></mat-divider>
  </div>
  <div class="col-12" *ngIf="factoryData.warehouse">
    <div class="title-content text-center">
      <mat-slide-toggle
        [(ngModel)]="detailsChecked"
        class="title"
        color="primary"
        >Detalles</mat-slide-toggle
      >
    </div>
  </div>
  <div class="col-12" *ngIf="detailsChecked && factoryData.oees.length > 0">
    <mtx-grid
      [data]="factoryData.oees"
      [columns]="columns"
      [length]="length"
      [pageOnFront]="true"
      [noResultText]="noResultText"
      [pageIndex]="query.pageIndex"
      [pageSize]="query.pageSize"
      [headerTemplate]="{
        warehouse: headerTpl,
        date: headerTpl,
        totalDeadTime: headerTpl,
        totalRealRunningTime: headerTpl,
        totalTimeWorked: headerTpl,
        deadTime: headerTpl,
        availability: headerTpl,
        efficiency: headerTpl,
        quality: headerTpl,
        oee: headerTpl
      }"
      [cellTemplate]="{
        warehouse: warehouseTpl,
        date: dateTpl,
        totalDeadTime: totalDeadTimeTpl,
        totalRealRunningTime: totalRealRunningTimeTpl,
        totalTimeWorked: totalTimeWorkedTpl,
        deadTime: deadTimeTpl,
        availability: availabilityTpl,
        efficiency: efficiencyTpl,
        quality: qualityTpl,
        oee: oeeTpl
      }"
    >
    <ng-template class="no-border" #headerTpl let-row let-index="index" let-col="colDef">
      <div class="text-center tbl-header">{{ row?.header }}</div>
    </ng-template>
    <!-- Template for cells -->
      <ng-template #warehouseTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.warehouse }}
        </div>
      </ng-template>
      <ng-template #dateTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ getDate(row?.date) }}
        </div>
      </ng-template>
      <ng-template #totalDeadTimeTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.totalDeadTime }}
        </div>
      </ng-template>
      <ng-template #totalRealRunningTimeTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.totalRealRunningTime }}
        </div>
      </ng-template>
      <ng-template #totalTimeWorkedTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.totalTimeWorked }}
        </div>
      </ng-template>
      <ng-template #deadTimeTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.deadTime }} %
        </div>
      </ng-template>
      <ng-template #availabilityTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.availability }} %
        </div>
      </ng-template>
      <ng-template #efficiencyTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.efficiency }} %
        </div>
      </ng-template>
      <ng-template #qualityTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.quality }} %
        </div>
      </ng-template>
      <ng-template #oeeTpl let-row let-index="index" let-col="colDef">
        <div
          [class]="
            'text-center trmvstm ' +
            (row?.warehouse == factoryData.factory ? 'row-blue' : '')
          "
        >
          {{ row?.oee }} %
        </div>
      </ng-template>
    </mtx-grid>
  </div>
</div>
